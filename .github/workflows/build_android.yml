# Ø§Ø³Ù… Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„
name: Build Android APK

# ÙŠØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ± Ø¹Ù†Ø¯ Push Ø¹Ù„Ù‰ main Ø£Ùˆ Ø¹Ù†Ø¯ Pull Request
on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: # ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

# Ø§Ù„Ù…Ù‡Ø§Ù…
jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java 17
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5' # Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø©
          channel: 'stable'
          cache: true

      # 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥ØµØ¯Ø§Ø± Flutter
      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      # 5. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
      - name: Create missing model files
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ invoice_item_model.dart Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹
          if [ ! -s lib/models/invoice_item_model.dart ]; then
            cat > lib/models/invoice_item_model.dart << 'EOF'
          class InvoiceItem {
            int? id;
            int? invoiceId;
            String productName;
            int quantity;
            double price;
            String? notes;
            DateTime createdAt;

            InvoiceItem({
              this.id,
              this.invoiceId,
              required this.productName,
              required this.quantity,
              required this.price,
              this.notes,
              DateTime? createdAt,
            }) : createdAt = createdAt ?? DateTime.now();

            double get total => quantity * price;

            factory InvoiceItem.fromMap(Map<String, dynamic> map) {
              return InvoiceItem(
                id: map['id'] as int?,
                invoiceId: map['invoice_id'] as int?,
                productName: map['product_name'] as String,
                quantity: map['quantity'] as int,
                price: (map['price'] as num).toDouble(),
                notes: map['notes'] as String?,
                createdAt: DateTime.parse(map['created_at'] as String),
              );
            }

            Map<String, dynamic> toMap() {
              return {
                'id': id,
                'invoice_id': invoiceId,
                'product_name': productName,
                'quantity': quantity,
                'price': price,
                'notes': notes,
                'created_at': createdAt.toIso8601String(),
              };
            }

            Map<String, dynamic> toJson() {
              return {
                'id': id,
                'invoice_id': invoiceId,
                'product_name': productName,
                'quantity': quantity,
                'price': price,
                'notes': notes,
                'created_at': createdAt.toIso8601String(),
              };
            }

            factory InvoiceItem.fromJson(Map<String, dynamic> json) {
              return InvoiceItem(
                id: json['id'] as int?,
                invoiceId: json['invoice_id'] as int?,
                productName: json['product_name'] as String,
                quantity: json['quantity'] as int,
                price: (json['price'] as num).toDouble(),
                notes: json['notes'] as String?,
                createdAt: DateTime.parse(json['created_at'] as String),
              );
            }

            InvoiceItem copyWith({
              int? id,
              int? invoiceId,
              String? productName,
              int? quantity,
              double? price,
              String? notes,
              DateTime? createdAt,
            }) {
              return InvoiceItem(
                id: id ?? this.id,
                invoiceId: invoiceId ?? this.invoiceId,
                productName: productName ?? this.productName,
                quantity: quantity ?? this.quantity,
                price: price ?? this.price,
                notes: notes ?? this.notes,
                createdAt: createdAt ?? this.createdAt,
              );
            }
          }
          EOF
          fi

      # 6. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙØ§Ø±ØºØ©
      - name: Create fonts directory
        run: |
          mkdir -p assets/fonts
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„Ø®Ø·ÙˆØ· (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
          touch assets/fonts/Cairo-Regular.ttf
          touch assets/fonts/Cairo-Bold.ttf
          touch assets/fonts/Cairo-SemiBold.ttf

      # 7. Ø¥ØµÙ„Ø§Ø­ package name ÙÙŠ MainActivity.kt
      - name: Fix package name in MainActivity
        run: |
          mkdir -p android/app/src/main/kotlin/com/invoicespro/app
          cat > android/app/src/main/kotlin/com/invoicespro/app/MainActivity.kt << 'EOF'
          package com.invoicespro.app

          import io.flutter.embedding.android.FlutterActivity

          class MainActivity : FlutterActivity()
          EOF

      # 8. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      - name: Clean project
        run: flutter clean

      # 9. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø²Ù…
      - name: Install dependencies
        run: flutter pub get

      # 10. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
      - name: Analyze code
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      # 11. Ø¨Ù†Ø§Ø¡ APK (Debug)
      - name: Build Debug APK
        run: flutter build apk --debug --verbose

      # 12. Ø¨Ù†Ø§Ø¡ APK (Release) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ
      - name: Build Release APK
        run: flutter build apk --release --verbose
        continue-on-error: true

      # 13. Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª
      - name: Rename APK files
        run: |
          mkdir -p build/outputs
          cp build/app/outputs/flutter-apk/app-debug.apk build/outputs/invoices-pro-debug.apk
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-release.apk build/outputs/invoices-pro-release.apk
          fi

      # 14. Ø±ÙØ¹ APK (Debug)
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: invoices-pro-debug-apk
          path: build/outputs/invoices-pro-debug.apk
          if-no-files-found: error
          retention-days: 30

      # 15. Ø±ÙØ¹ APK (Release) - Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
      - name: Upload Release APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: invoices-pro-release-apk
          path: build/outputs/invoices-pro-release.apk
          if-no-files-found: ignore
          retention-days: 90

      # 16. Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù€ APK
      - name: APK Info
        run: |
          echo "ðŸ“¦ Debug APK Size:"
          ls -lh build/outputs/invoices-pro-debug.apk || echo "Debug APK not found"
          
          if [ -f build/outputs/invoices-pro-release.apk ]; then
            echo "ðŸ“¦ Release APK Size:"
            ls -lh build/outputs/invoices-pro-release.apk
          fi

      # 17. Ø¥Ù†Ø´Ø§Ø¡ Release Ø¹Ù„Ù‰ GitHub (Ø¹Ù†Ø¯ Push Ø¹Ù„Ù‰ main)
      - name: Create GitHub Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: |
            ## ðŸ“± ØªØ·Ø¨ÙŠÙ‚ ÙÙˆØ§ØªÙŠØ± Ø¨Ø±Ùˆ
            
            ### Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¥ØµØ¯Ø§Ø±:
            - âœ… Ø¨Ù†Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ø¨Ø± GitHub Actions
            - ðŸ“¦ Ù†Ø³Ø®Ø© Debug Ùˆ Release
            - ðŸ”§ Ø¥ØµÙ„Ø§Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
            
            ### Ø§Ù„ØªØ­Ù…ÙŠÙ„:
            - **Debug APK**: Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±
            - **Release APK**: Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙØ¹Ù„ÙŠ
            
            ---
            ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ: ${{ github.event.head_commit.timestamp }}
          files: |
            build/outputs/invoices-pro-debug.apk
            build/outputs/invoices-pro-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
